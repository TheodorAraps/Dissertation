\chapter{Πρακτική Υλοποίηση του Συστήματος}
\InitialCharacter{Σ}το κεφάλαιο αυτό παρουσιάζεται βήμα προς βήμα η πρακτική υλοποίηση 
του συστήματος, από την αρχική εγκατάσταση μέχρι την πλήρη ολοκλήρωση (\en{integration}) 
των υποσυστημάτων. Αφετηρία αποτελεί η προετοιμασία του \en{LoRaWAN gateway}, το οποίο 
φιλοξενεί με χρήση \en{Docker} τις υπηρεσίες \en{The Things Stack} και 
\en{LoRa Basics Station}, με αναλυτικές ρυθμίσεις, εντολές και επιλογές παραμετροποίησης 
ώστε να συνδεθεί με ασφάλεια και να λειτουργεί αξιόπιστα. Στη συνέχεια τεκμηριώνεται ο 
προγραμματισμός των τριφασικών μετρητών και η σύνδεσή τους με το \en{gateway}, με 
έμφαση στη ροή των δεδομένων και τον τρόπο διαμόρφωσης των \en{uplinks}. Τέλος, 
περιγράφεται η υλοποίηση της τελικής \en{web} εφαρμογής και η ανάπτυξή της στο ίδιο 
\en{gateway}, ολοκληρώνοντας μια ενιαία υποδομή από το πεδίο μέχρι το περιβάλλον χρήστη.




% ----------------------------------------
% Ενότητα 5.1 Προετοιμασία LoRaWAN gateway
% ----------------------------------------




\section{Προετοιμασία \en{LoRaWAN gateway}}


%%%%   Υποενότητα 5.1.1: Διασύνδεση Hardware   %%%%

\subsection{Διασύνδεση \en{Hardware}}
Αρχικά ξεκινάμε με την σύνδεση των επιμέρους εξαρτημάτων όπως περιγράφηκε στην Ενότητα \ref{sec:4.2}, 
σύμφωνα με την Εικόνα \ref{figure4.2} και τον Πίνακα \ref{tab:ic880a_rpi_pins}:

\begin{Illustration}[!ht] 
  \centering
	\includegraphics[width=0.85\textwidth]{figures/LoRaWAN_gateway_setup.jpg} 
  \caption{Τελική συνδεσμολογία των εξαρτημάτων.}
  \label{figure5.1}
\end{Illustration} 

%%%%   Υποενότητα 5.1.2: Εγκατάσταση λειτουργικού συστήματος   %%%%

\subsection{Εγκατάσταση λειτουργικού συστήματος}
Για την αρχική προετοιμασία του \en{Raspberry Pi} απαιτείται η εγκατάσταση του 
λειτουργικού συστήματος στην κάρτα \en{microSD}. Η διαδικασία μπορεί να γίνει πλήρως 
\en{headless} χωρίς οθόνη ή πληκτρολόγιο, αξιοποιώντας το εργαλείο 
\en{Raspberry Pi Imager}. Ακολουθούν τα απαραίτητα βήματα, με πρόσθετες ρυθμίσεις 
ώστε το σύστημα να ξεκινήσει έτοιμο για δικτυακή πρόσβαση και παραμετροποίηση.

\begin{enumerate}
\item Συνδέουμε την κάρτα \en{microSD} στον υπολογιστή μέσω \en{card reader} και ανοίγουμε το \en{Raspberry Pi Imager}.
\begin{Illustration}[!ht] 
  \centering
	\includegraphics[width=0.7\textwidth]{figures/Raspberry_Pi_imager_1.png} 
  \caption{\en{Raspberry Pi Imager.}}
  \label{figure5.2}
\end{Illustration} 

\item Επιλέγουμε \textbf{\en{Choose Device}} και από τη λίστα διαλέγουμε \textbf{\en{Raspberry Pi 4}}, που είναι το μοντέλο της συσκευής Raspberry Pi που χρησιμοποιύμε.
\item Επιλέγουμε \textbf{\en{Choose OS}} και από τη λίστα διαλέγουμε \textbf{\en{Raspberry Pi OS Lite (64-bit)}}, που είναι η έκδοση χωρίς γραφικό περιβάλλον και ενδείκνυται για \en{servers}.
\item Πατάμε \textbf{\en{Choose Storage}} και επιλέγουμε τη σωστή \en{microSD}.
\item Πατάμε \textbf{\en{Next}} και στο αναδυόμενο παράθυρο επιλέγουμε \textbf{\en{Edit Settings}} και ρυθμίζουμε:

\begin{Illustration}[!ht] 
  \centering
	\includegraphics[width=0.7\textwidth]{figures/Raspberry_Pi_imager_2.png} 
  \caption{\en{Apply OS Customisation settings Option}.}
  \label{figure5.3}
\end{Illustration} 

Στην καρτέλα \textbf{\en{General}}:
\begin{itemize}
\item \textbf{\en{set Hostname}}: Θέτουμε \en{loragateway} ώστε η συσκευή να είναι προσβάσιμη στο δίκτυο ως \en{loragateway.local}.
\item \textbf{\en{Set username and password}}: ορίζουμε μη προεπιλεγμένα διαπιστευτήρια για λόγους ασφάλειας.
\item \textbf{\en{Configure wireless LAN (optional)}}: εφόσον γίνει αρχικά σύνδεση μέσω \en{Wi-Fi}, συμπληρώνουμε \en{SSID}, \en{password} και \en{country} \en{GR}. Έτσι η συσκευή μπορεί να συνδεθεί στο δίκτυό μας απευθείας, χωρίς περαιτέρω ρυθμίσεις. 
\end{itemize}
\begin{Illustration}[!ht] 
  \centering
	\includegraphics[width=0.7\textwidth]{figures/Raspberry_Pi_imager_3.png} 
  \caption{\en{General OS Customisation settings}.}
  \label{figure5.4}
\end{Illustration} 

Στην καρτέλα \textbf{\en{Services}}:
\begin{itemize}
\item \textbf{\en{Enable SSH}}: ενεργοποιούμε \en{SSH} για απομακρυσμένη πρόσβαση με \en{password}.
\end{itemize}
\begin{Illustration}[!ht] 
  \centering
	\includegraphics[width=0.7\textwidth]{figures/Raspberry_Pi_imager_4.png} 
  \caption{\en{Services OS Customisation settings}.}
  \label{figure5.5}
\end{Illustration} 

Τέλος, πατάμε \textbf{\en{Save}} και ύστερα \textbf{\en{Yes}} στο προηγούμενο αναδυόμενο 
παράθυρο ώστε να εφαρμόσουμε τις ρυθμίσεις που κάναμε και να ξεκινήσει η εγγραφή της εικόνας του 
λειτουργικού συστήματος στην κάρτα \en{microSD}. Επιβεβαιώνουμε την επαλήθευση και αφαιρούμε με ασφάλεια το μέσο.

\item Τοποθετούμε την \en{microSD} στο \en{Raspberry Pi} και συνδέουμε την τροφοδοσία. Το σύστημα εκκινεί σε λίγα δευτερόλεπτα.
\item Από τον υπολογιστή μας συνδεόμαστε απομακρυσμένα με \en{SSH}:


\begin{itemize}
\item Εντοπίζουμε τη διεύθυνση \en{IP} από το \en{router} μας (στην περίπτωσή μας έχουμε 192.168.0.100) και εκτελούμε: 
\begin{otherlanguage*}{english}
\begin{lstlisting}[style=bashstyle, label={lst:apt-upgrade}]
ssh loragw@192.168.0.100
\end{lstlisting}
\end{otherlanguage*}
\item Βάζουμε τον κωδικό που θέσαμε προηγουμένως για τον χρήστη \en{loragw} και συνδεόμαστε επιτυχώς.
\end{itemize}
\item Μετά την πρώτη σύνδεση, εκτελούμε βασικές ενημερώσεις συστήματος και εργαλείων συντήρησης:


\begin{otherlanguage*}{english}
\begin{lstlisting}[style=bashstyle, label={lst:apt-upgrade}]
sudo apt update && sudo apt full-upgrade -y
sudo reboot
\end{lstlisting}
\end{otherlanguage*}



\medskip

\item Μόλις ολοκληρωθεί η εγκατάσταση, για να εξασφαλιστεί ο συγχρονισμός και η σωστή 
επικοινωνία των δύο συσκευών, χρειάζεται να ενεργοποιηθεί η διεπαφή \en{SPI} από τις 
ρυθμίσεις του \en{Raspberry Pi}. Αυτό γίνεται ανοίγοντας το εργαλείο παραμετροποίησης 
\en{Raspberry Pi Software Configuration Tool} με την εντολή:
\begin{otherlanguage*}{english}
\begin{lstlisting}[style=bashstyle, label={lst:apt-upgrade}]
+sudo raspi-config
\end{lstlisting}
\end{otherlanguage*}

Από το μενού που εμφανίζεται επιλέγουμε \textbf{\en{Interface options}}.

\begin{Illustration}[!ht] 
  \centering
	\includegraphics[width=0.9\textwidth]{figures/Raspi_config.jpg} 
  \caption{Εργαλείο παραµετροποίησης λογισµικού του \en{Raspberry Pi}}
  \label{figure5.6}
\end{Illustration} 

\newpage
Έπειτα, επιλέγουµε το \textbf{\en{I4 SPI}} και απαντάµε µε \en{yes} στο αναδυόµενο παράθυρο που µας
ρωτάει αν θέλουμε να ενεργοποιήσουμε την προαναφερθείσα διεπαφή:

\begin{Illustration}[!ht] 
  \centering
	\includegraphics[width=0.9\textwidth]{figures/Raspi_config_2.jpg} 
  \caption{Επιλογή ενεργοποιήσης διεπαφής \en{SPI}}
  \label{figure5.7}
\end{Illustration} 

Τέλος, πατάμε \en{Esc} στο πληκτρολόγιο ώστε να βγούμε από το εργαλείο \en{raspi-config}.

\item Ολοκληρώνουμε την διαδικασία εγκατάστασης και παραμετροποίησης του λειτουργικού συστήματος εγκαθιστώντας ορισμένα απαραίτητα εργαλεία για το στήσιμο των υπηρεσιών, τρέχοντας την εντολή:
\newpage
\begin{otherlanguage*}{english}
\begin{lstlisting}[style=bashstyle, label={lst:apt-upgrade}]
sudo apt-get install git gcc make
\end{lstlisting}
\end{otherlanguage*}
\end{enumerate}

Με αυτά τα βήματα, το \en{Raspberry Pi OS Lite} είναι έτοιμο για την εγκατάσταση των εργαλείων και 
των υπηρεσιών που που θα χρειαστούν για την λειτουργία του συστήματός μας.


%%%%   Υποενότητα 5.1.3: Εγκατάσταση Docker και Docker Compose   %%%%


\subsection{Εγκατάσταση \en{Docker} και \en{Docker Compose}}
Για την ομαλή φιλοξενία των υπηρεσιών (\en{The Things Stack}, \en{LoRa Basics Station} και αργότερα της 
\en{web} εφαρμογής) στο \en{Raspberry Pi}, εγκαθίσταται το \en{Docker Engine} μαζί με το 
\en{container runtime} \en{containerd} και το πρόσθετο \en{Docker Compose} (νέας γενιάς ως 
\en{docker compose} \en{plugin}). Παρακάτω παρατίθενται τα βήματα που εκτελέστηκαν, με σύντομη επεξήγηση 
για κάθε εντολή.

\begin{itemize}
\item Κατεβάζουμε με ασφάλεια το \en{script} (εκτελέσιμο αρχείο εντολών) εγκατάστασης του 
\en{Docker} από τον επίσημο ιστότοπο και το αποθηκεύουμε ως \en{get-docker.sh}.
\begin{otherlanguage*}{english}
\begin{lstlisting}[style=bashstyle]
curl -fsSL https://get.docker.com -o get-docker.sh
\end{lstlisting}
\end{otherlanguage*}

\item Τρέχουμε το \en{script} ως \en{root} χρήστης και εγκαθιστούμε το \en{Docker Engine}, 
τον \en{containerd} και τα απαιτούμενα πακέτα (\en{packages}) για να λειτουργήσει ομαλά το \en{Docker}.
\begin{otherlanguage*}{english}
\begin{lstlisting}[style=bashstyle]
sudo sh get-docker.sh
\end{lstlisting}
\end{otherlanguage*}

\item Δημιουργούμε ένα \en{Unix group} με όνομα \en{docker}, ώστε οι χρήστες-μέλη του 
να μπορούν να εκτελούν εντολές \en{docker} χωρίς το πρόθεμα \en{sudo} (παρέχει προνόμοια 
\en{root} χρήστη). Αν υπάρχει ήδη, η εντολή απλά αποτυγχάνει χωρίς κίνδυνο.
\begin{otherlanguage*}{english}
\begin{lstlisting}[style=bashstyle]
sudo groupadd docker
\end{lstlisting}
\end{otherlanguage*}

\item Εντάσσουμε τον τωρινό χρήστη του περιβάλλοντος (\en{\$USER}, στην περίπτωση μας τον 
loragw που έχουμε συνδεθεί) στο \en{group} \en{docker} για \en{non-root} χρήση του \en{Docker}.
\begin{otherlanguage*}{english}
\begin{lstlisting}[style=bashstyle]
sudo usermod -aG docker $USER
\end{lstlisting}
\end{otherlanguage*}

\item Δημιουργούμε ένα καινούριο \en{shell session} και θέτουμε τον χρήστη μας ως μέλος του \en{docker group} 
χωρίς να απαιτείται πλήρης αποσύνδεση/επανασύνδεση (\en{re-login}). Εναλλακτικά, μπορούμε να κάνουμε \en{logout/login}.
\begin{otherlanguage*}{english}
\begin{lstlisting}[style=bashstyle]
newgrp docker
\end{lstlisting}
\end{otherlanguage*}

% \paragraph{Ενεργοποίηση \en{Docker} στην εκκίνηση.}
\item Θέτουμε την υπηρεσία \en{docker.service} να εκκινεί αυτόματα σε κάθε εκκίνηση (\en{boot}) του 
συστήματος (\en{systemd enable}).
\begin{otherlanguage*}{english}
\begin{lstlisting}[style=bashstyle]
sudo systemctl enable docker.service
\end{lstlisting}
\end{otherlanguage*}

\pagebreak

\item Αντίστοιχα, ενεργοποιούμε και το \en{containerd.service} (το \en{runtime} που χρησιμοποιεί 
το \en{Docker Engine}).

\begin{otherlanguage*}{english}
\begin{lstlisting}[style=bashstyle]
sudo systemctl enable containerd.service
\end{lstlisting}
\end{otherlanguage*}
\end{itemize}

\subsubsection{(Προαιρετικό) Επαλήθευση εγκατάστασης}

\noindent Ελέγχούμε ότι το \en{Docker Engine} κι το \en{Compose} \en{plugin} είναι διαθέσιμα. 
\begin{otherlanguage*}{english}
\begin{lstlisting}[style=bashstyle]
docker --version
docker compose version
\end{lstlisting}
\end{otherlanguage*}

\noindent Αν η δεύτερη εντολή δεν επιστρέψει έκδοση, εγκαθιστούμε το \en{plugin}. 
\begin{otherlanguage*}{english}
\begin{lstlisting}[style=bashstyle]
sudo apt-get install docker-compose-plugin
\end{lstlisting}
\end{otherlanguage*}

\subsubsection{(Προαιρετικό) Δοκιμαστικό \en{run}.}
\noindent Με την ακόλουθη εντολή τραβάμε και εκτελούμε ένα ελαφρύ δοκιμαστικό \en{container} για να 
επαληθεύσουμε ότι ο \en{Docker} λειτουργεί σωστά χωρίς \en{sudo}.
\begin{otherlanguage*}{english}
\begin{lstlisting}[style=bashstyle]
docker run --rm hello-world
\end{lstlisting}
\end{otherlanguage*}


%%%%   Υποενότητα 5.1.4: Εγκατάσταση του The Things Stack   %%%%

\subsection{Εγκατάσταση του \en{The Things Stack}}

